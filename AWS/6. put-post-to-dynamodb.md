# POST & PUT Data To DynamoDB

<img src="https://i.imgur.com/Wmp6bps.png" width=700/> 



This lecture will focus on creating new items and updating existing items in DynamoDB using data received via POST route. We will focus on the following:

- updating the project-create Lambda function to create new items in DynamoDB
- updating the project-show Lambda function to update existing items in DynamoDB

<img src="https://i.imgur.com/Wm201Mw.png">

```js
{
  "errorType": "AccessDeniedException",
  "errorMessage": "User: arn:aws:sts::004543502724:assumed-role/projects-demo-create-role-hcb45a1s/projects-demo-create is not authorized to perform: dynamodb:PutItem on resource: arn:aws:dynamodb:us-east-1:004543502724:table/compare-yourself",
  "trace": [
    "AccessDeniedException: User: arn:aws:sts::004543502724:assumed-role/projects-demo-create-role-hcb45a1s/projects-demo-create is not authorized to perform: dynamodb:PutItem on resource: arn:aws:dynamodb:us-east-1:004543502724:table/compare-yourself",
    "    at Request.extractError (/var/runtime/node_modules/aws-sdk/lib/protocol/json.js:52:27)",
```

<img src="https://i.imgur.com/Wpdigql.png">

```js
const params = {
    Item: {
        "ProjectId": {
            S: `project_${Math.random()}`
        },
        "Title": {
            S: event.title
        },
        "Image": {
            S: event.image
        },
        "Description": {
            S: event.description
        }
    },
    TableName: "projects"
};  
```

```js
await dynamodb.putItem(params, function(err, data) {
    console.log('err', err, 'data', data)
    if (err) {
        console.log('err', err);
    } else {
        console.log('data', data);
        response.body = data
    }
}).promise()
```

```js
response.body = params
```

<img src="https://i.imgur.com/IZ5CM68.png">

<img src="https://i.imgur.com/BCSLnfx.png">

<img src="https://i.imgur.com/tzky8Ne.png">

```js
{
  "title": "New Project",
  "image": "https://i.imgur.com/L9K6hli.png",
  "description": "Add project description here..."
}
```

Let's format the in the **Integration Response** using a **Mapping Template**.  Create a new **Mapping Tempalate** and assign it a **Content Type** of **application/json**. 

#### AWS Documentation

It's as this point we need to take a look at the [AWS Documentation](https://docs.amazonaws.cn/en_us/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html#input-variable-reference) regarding what this involves.  

If we take a look specifically at **input variables** we can see that the route retrieves the value of the path, query string or header using **$input.json(x)**.  


<img src="https://i.imgur.com/p5i3suH.png">


Here we will add the following code. 

<img src="https://i.imgur.com/3iqLYvD.png">

Let's update the **PUT Integration Response** to mirror what we assigned for the **POST Integration Response**

```js
{
 "statusCode": $input.json('$.statusCode'),
 "body": {
    "projectId": $input.json('$.body.Item.ProjectId.S')
    "title": $input.json('$.body.Item.Title.S')
    "image": $input.json('$.body.Item.Image.S')
    "description": $input.json('$.body.Item.Description.S')
 }
}
```

```js
const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB({region: 'us-east-1', apiVersion: '2012-08-10'});

exports.handler = async (event) => {
    console.log('event', event)
    
    const response = {
        statusCode: 200,
    }
    
    const params = {
        Item: {
            "ProjectId": {
                S: event.id
            },
            "Title": {
                S: event.title
            },
            "Image": {
                S: event.image
            },
            "Description": {
                S: event.description
            }
        },
        TableName: "projects"
    };
    
    await dynamodb.putItem(params, function(err, data) {
        console.log('err', err, 'data', data)
        if (err) {
            console.log('err', err);
        } else {
            console.log('data', data);
            response.body = params
        }
    }).promise()

    
    return response
};
```

<img src="https://i.imgur.com/s1qr6yD.png">

Permissions Error

<img src="https://i.imgur.com/wia5svN.png">

Testing Via API Gateway

<img src="https://i.imgur.com/H963ZLv.png">